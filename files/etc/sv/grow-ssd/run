#!/bin/sh
# grow ssd partition and filesystem at boot (one-shot)

set -eu

# Wait for /ssd to be mounted (up to 60 seconds)
MAX_WAIT=60
WAITED=0
SSD_DEV=$(findmnt -n -o SOURCE /ssd 2>/dev/null || echo "")

case "$SSD_DEV" in
    /dev/*)
        # Already mounted, proceed
        ;;
    *)
        # Not yet mounted, wait for it
        echo "grow-ssd: waiting for /ssd to be mounted..."
        while [ $WAITED -lt $MAX_WAIT ]; do
            SSD_DEV=$(findmnt -n -o SOURCE /ssd 2>/dev/null || echo "")
            case "$SSD_DEV" in
                /dev/*)
                    echo "grow-ssd: /ssd is mounted on $SSD_DEV"
                    break
                    ;;
            esac
            sleep 1
            WAITED=$((WAITED + 1))
        done
        # Check if we actually found the device
        case "$SSD_DEV" in
            /dev/*)
                # Successfully detected, continue
                ;;
            *)
                echo "grow-ssd: unable to detect source device for /ssd; skipping"
                sv down /var/service/grow-ssd >/dev/null 2>&1 || true
                exit 0
                ;;
        esac
        ;;
esac

# Parse disk and partition from the device path
case "$SSD_DEV" in
    # Bare NVMe namespace device, e.g. /dev/nvme0n1
    /dev/nvme[0-9]n[0-9])
        DISK="$SSD_DEV"
        PART=""
        ;;
    # NVMe partition device, e.g. /dev/nvme0n1p1 -> /dev/nvme0n1
    /dev/nvme[0-9]n[0-9]p[0-9]*)
        DISK=$(printf '%s\n' "$SSD_DEV" | sed -E 's/p[0-9]+$//')
        PART=$(printf '%s\n' "$SSD_DEV" | sed -E 's/.*p([0-9]+)$/\1/')
        ;;
    # Non-NVMe devices with numeric partition suffix, e.g. /dev/sda1 -> /dev/sda
    /dev/*[0-9])
        DISK=$(printf '%s\n' "$SSD_DEV" | sed -E 's/[0-9]+$//')
        PART=$(printf '%s\n' "$SSD_DEV" | sed -E 's/.*[^0-9]([0-9]+)$/\1/')
        ;;
    # Fallback: leave as-is if we cannot reliably parse
    *)
        DISK="$SSD_DEV"
        PART=""
        ;;
esac

# If the device has a parent (e.g., LVM, LUKS), use the parent as the disk
PKNAME=$(lsblk -no pkname "$SSD_DEV" 2>/dev/null || echo "")
if [ -n "$PKNAME" ]; then
    DISK="/dev/$PKNAME"
fi

# No support for bare non-partitioned devices currently
case "$PART" in
    ''|*[!0-9]*)
        echo "grow-ssd: unable to determine partition number from $SSD_DEV or no partition; skipping"
        sv down /var/service/grow-ssd >/dev/null 2>&1 || true
        exit 0
        ;;
esac

# Only run if partition can be grown
growpart --dry-run "$DISK" "$PART" >/dev/null 2>&1 || {
    sv down /var/service/grow-ssd >/dev/null 2>&1 || true
    exit 0
}

echo "Growing partition $SSD_DEV"
growpart "$DISK" "$PART"

echo "Resizing filesystem on $SSD_DEV"
resize2fs "$SSD_DEV"

echo "grow-ssd completed"

# Disable the service after successful completion
sv down /var/service/grow-ssd >/dev/null 2>&1 || true
